
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.3">
    
    
      
        <title>Install with Docker - PORI</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.e35208c4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../styles.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#install-with-docker" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PORI" class="md-header__button md-logo" aria-label="PORI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PORI
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Install with Docker
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        
<a href="https://github.com/bcgsc/pori/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    github
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PORI" class="md-nav__button md-logo" aria-label="PORI" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    PORI
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bcgsc/pori/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Install with Docker
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Install with Docker
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#build-the-authentication-server" class="md-nav__link">
    Build the Authentication Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-compose" class="md-nav__link">
    Docker-Compose
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../repos/" class="md-nav__link">
        Repositories
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#build-the-authentication-server" class="md-nav__link">
    Build the Authentication Server
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#docker-compose" class="md-nav__link">
    Docker-Compose
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bcgsc/pori/edit/master/docs/install.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="install-with-docker">Install with Docker</h1>
<p>The simplest way to get the entire platform up an running from scratch is using docker. Most of the servers are auto-started together with docker-compose but the keycloak container must be started and configured on its own first. The instructions below set up the platform with HTTP and then use a reverse proxy to pick up the ports. This way you can omit the proxy step and run the platform with http when initialling setting up and testing.</p>
<p>Start by cloning this repository which contains the default docker compose config (docker-compose.yml)</p>
<div class="highlight"><pre><span></span><code>git clone https://github.com/bcgsc/pori.git
<span class="nb">cd</span> pori
</code></pre></div>
<h2 id="build-the-authentication-server">Build the Authentication Server</h2>
<p>The following command builds the basic keycloak container for PORI. This contains a base realm
configuration</p>
<div class="highlight"><pre><span></span><code>docker build <span class="se">\</span>
    -t bcgsc/pori-auth <span class="se">\</span>
    -f Dockerfile.auth <span class="se">\</span>
    .
</code></pre></div>
<p>Then you will run the container (change the password and username as desired)</p>
<div class="highlight"><pre><span></span><code>docker run <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_USER</span><span class="o">=</span>admin <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_PASSWORD</span><span class="o">=</span>&lt;PASSWORD&gt; <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_FRONTEND_URL</span><span class="o">=</span>&lt;URL&gt; <span class="se">\</span>
    -p <span class="m">8443</span>:8334 <span class="se">\</span>
    -p <span class="m">8888</span>:8080 <span class="se">\</span>
    -d <span class="se">\</span>
    --mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/etc/ssl/certs/current,target<span class="o">=</span>/etc/x509/https,readonly <span class="se">\</span>
    bcgsc/pori-auth:latest
</code></pre></div>
<p>For the demo server (excluding password) this looked like</p>
<div class="highlight"><pre><span></span><code>docker run <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_USER</span><span class="o">=</span>admin <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_PASSWORD</span><span class="o">=</span><span class="nv">$DEMO_KC_ADMIN</span> <span class="se">\</span>
    -e <span class="nv">KEYCLOAK_FRONTEND_URL</span><span class="o">=</span>https://pori-demo.bcgsc.ca/auth <span class="se">\</span>
    -p <span class="m">8443</span>:8334 <span class="se">\</span>
    -p <span class="m">8888</span>:8080 <span class="se">\</span>
    -d <span class="se">\</span>
    --mount <span class="nv">type</span><span class="o">=</span>bind,source<span class="o">=</span>/etc/ssl/certs/current,target<span class="o">=</span>/etc/x509/https,readonly <span class="se">\</span>
    bcgsc/pori-auth:latest
</code></pre></div>
<p>Check that the docker container has started</p>
<div class="highlight"><pre><span></span><code>docker ps
</code></pre></div>
<p>You should see something like this</p>
<div class="highlight"><pre><span></span><code>CONTAINER ID   IMAGE                  COMMAND                  CREATED              STATUS              PORTS                              NAMES
16ff3826c976   bcgsc/pori-auth:latest   &quot;/opt/jboss/tools/do…&quot;   About a minute ago   Up About a minute   8443/tcp, 0.0.0.0:8888-&gt;8080/tcp   strange_chaum
</code></pre></div>
<p>After the container is started you can go to the admin console GUI to add a users and download the realm's public key file. This must be done prior to starting the other containers.</p>
<p>The public key file will need to be passed to the GraphKB API container at run time. Copy it from the Realms &gt; Keys page which should look something like below</p>
<p><img alt="keycloak realms page" src="../images/keycloak-get-public-key.png" /></p>
<p>For the purposes of this example we have saved it as <code>keys/keycloak.key</code> and we will mount the keys directory to the api container in the next step. The content of the file should look something like this</p>
<div class="highlight"><pre><span></span><code>-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAoteEI/Iu923I4Zqt8prxIx3ljGEecnrI+sWjo4U3n14n/nY5NpfCiA+Pg1WQTQKsBHX5/sIm+Fn5FJpcpBzz8/5uEQJyPEOEezEuiP/yYjVbg4S25reOaQNRfsw7yZvdgrMySy3MrfjWw+luLa6Nt4AvZ6ywOqE8Q4SZgVxGQg07acenpR6U+bkNj3AxFFEeYqiktfKPI7iLykVBz/hXANnrs9zd036vcgAYa2IxmWpo38ZOksKTgYL5IDG1zZ5S6VM43mD7hE8jG+kCVbiNVlrYFTXxIkRmaOO9krykPoLux7tjXAFEfTwMji++HQjc724FigsnoJ3xZkUzCSzkTQIDAQAB
-----END PUBLIC KEY-----
</code></pre></div>
<p>Both the IPR and GraphKB API containers will use this ./keys folder, binding it into the container at run time (See volumes section of docker compose file).</p>
<p>You will also want to add a couple of users to make things simpler to test. If you use the non-default demo passwords (RECCOMMENDED!) you will need to change the corresponding fields in the docker compose file. The names of these users can also be changed but it will require also adding them to the application databases.</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Default in DB</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>graphkb_importer</td>
<td>GraphKB</td>
<td>This is the default user that is created when the new GraphKB DB is created. It is an admin user that can be used to add new users or import content</td>
</tr>
<tr>
<td>ipr_graphkb_link</td>
<td>GraphKB</td>
<td>This is the user used by IPR to pull data from GraphKB</td>
</tr>
<tr>
<td>iprdemo</td>
<td>IPR</td>
<td>This is an admin user in the IPR demo db</td>
</tr>
<tr>
<td>graphkb_admin</td>
<td>GraphKB</td>
<td>Admin user for managing content/users in the GraphKB web interface</td>
</tr>
</tbody>
</table>
<p>Add the above users to keycloak with the IPR and GraphKB roles.</p>
<p><img alt="adding users" src="../images/keycloak-add-users.png" /></p>
<h2 id="docker-compose">Docker-Compose</h2>
<p>Now you are ready to start the other services. This will use the <code>docker-compose.yml</code> file to configure the network.</p>
<p>First create empty directories to mount the database data, this will ensure the databases are not lost when you stop/restart the container</p>
<div class="highlight"><pre><span></span><code>databases/<span class="o">{</span>postgres,orientdb<span class="o">}</span>/<span class="o">{</span>backup,data<span class="o">}</span> -p
</code></pre></div>
<p>Next, use docker-compose to start the DB, API, and client servers. The paths/URLs in the docker-compose.yml file should be adjusted to match your deployment. In our demo deployment we have a proxy pass set up from the configured ports to handle the https layer</p>
<div class="highlight"><pre><span></span><code>docker-compose up
</code></pre></div>
<p>This will start the following services</p>
<ul>
<li>Postgres db server for IPR with a default db dump</li>
<li>OrientDB server for GraphKB with an empty default db</li>
<li>GraphKB API server (nodejs)</li>
<li>IPR API server (nodejs)</li>
<li>GraphKB client server (nginx)</li>
<li>IPR client server (nginx)</li>
</ul>
<p>Once the platform is live you can populate the new GraphKB instance with external content using the <a href="https://github.com/bcgsc/pori_graphkb_loader">loaders</a>.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href=".." class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              About
            </div>
          </div>
        </a>
      
      
        <a href="../repos/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Repositories
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.4ea5477f.min.js"></script>
      
    
  </body>
</html>